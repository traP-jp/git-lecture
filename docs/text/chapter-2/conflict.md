# コンフリクトの解決

ひとつのファイルを互いに同期される前に別々の方法で書き換えると **コンフリクト**（競合）が生じることがあります。出会いがちなパターン 2 つについて、試せる解決方法を記します。

## マージ競合

mydrive リポジトリで main ブランチから sub ブランチを生やしたとします。main ブランチと sub ブランチのそれぞれで異なる内容で README.md を変更してコミットしたのち、sub ブランチを main にマージしようとするとコンフリクトが生じます。

コンフリクトが発覚するのはプルリクエストを出した直後の Gitea の画面上です。

![](https://md.trap.jp/uploads/upload_aa628555d654142ffdf76c8b43a46f49.png)

集団開発で起きやすいコンフリクトです。

## ローカル環境間の同期競合

デスクトップディレクトリとダウンロードディレクトリの mydrive がともに main ブランチにいるとします。デスクトップ の mydrive で README.md を変更してコミットしたのち、ダウンロードの mydrive で「変更を同期」する前に README.md を変更してコミットしようとするとコンフリクトが生じます。

コンフリクトが発覚するのは VSCode 上で「コミット」ボタンを押した瞬間です。

![](https://md.trap.jp/uploads/upload_73ce431131502cb43c47ce3fc6cfc8e6.png)

main ブランチに直接コミットしながら個人開発をしている時に起きやすいコンフリクトです。

## マージ競合の解決

上で挙げた 2 種類のコンフリクトは、一見して全く異なるものであるようにも見えますが、じつは VSCode 上でほぼ同じ手順で解決することができます。ここでは「マージ競合」の方を例にとって説明します。

マージ競合が発生していることが Gitea の画面で判明したら、マージしようとしているブランチ（この場合は sub ブランチ）にいることを確認し、以下のように選択します。

![](https://md.trap.jp/uploads/upload_14b7413805c4a73632564cbdb42c038d.png)

次にウィンドウ上部で以下のように main を選択します。

![](https://md.trap.jp/uploads/upload_30b467cd528ea092623a088464dd77a4.png)

:::warning 基本的に直接マージはしない
もしコンフリクトがなかったとすれば、ここまでの操作によって main → sub のマージが実行され、main の変更が sub に反映されます。お察しの通り、もし sub ではなく main にいる状態で逆の操作をすると、**プルリクエストを出すことなく sub → main のマージが実行**されます。

これは操作としては可能ですが、共同開発においては当然おすすめできません。というより、基本的に**マージ競合の解決以外でブランチ同士を直接マージすることはありません**。マージ競合のときだけは例外で、main の内容を sub に直接マージしてコンフリクトを解決するという操作を伴います。main へのマージを希望する場合は必ずプルリクエストを立てましょう。
:::

マージ競合が発生している場合は、上の操作の直後に以下のような画面に飛びます。右下の「マージエディターで解決」ボタンを押してください。

![](https://md.trap.jp/uploads/upload_5ede45435ef2a34b0d4a49055de64aa9.png)

図のように画面が 3 つに分割されます。上 2 つがコンフリクトを起こしている部分の表示で、たった今マージしようとした sub ブランチでの変更は右側「現在のマシン」です。

sub ブランチでの変更を優先したい場合は「現在のマシン を適用する」を押します。main ブランチでの変更を優先したい場合は「受信中 を適用する」を押します。

![](https://md.trap.jp/uploads/upload_30ed91bfe6bb4ff462639f7468f49a1e.png)

上の図ではコンフリクトを生じている部分が濃い黄色の枠で囲まれていますが、コンフリクトの解決が終了すると枠が目立たなくなります。全てのコンフリクトを解決したら右下の「マージの完了」ボタンを押してください。

すると、コミットメッセージが予め入力された状態で以下のように「続行」ボタンが表示されるので押します。そのあとの「変更の同期」ボタンまで押すことで、コンフリクトの解決および main → sub のマージが完了します。

![](https://md.trap.jp/uploads/upload_506a8fbe12ad1674ce0ffe73ce488a77.png)

先ほどコンフリクトを告げられた Gitea のページをリロードすると、プルリクエストが「マージコミットを作成」可能な状態になっています。

![](https://md.trap.jp/uploads/upload_4f4432cb1184ab5dde625f014cc7260d.png)

## ローカル環境間同期競合の解決

まず「キャンセル」を押してダイアログを消します。次に、マージ競合の解決のときと同様に「ブランチ > マージ…」と選択し、**マージ元のブランチとして origin/main を選択**します。

:::info origin/main → main のマージ
origin/main は前編で登場した「main ブランチのリモート追跡ブランチ」ですから、先にコミットして変更を反映させたリモートブランチの情報を持っています。「origin/main → main のマージ」という操作は、先にコミットされた変更を手元の main ブランチに取り込むことを表しています。
:::

あとの手順はマージ競合の解決と同じです。

:::tip 手元のコミットをなかったことにする
場合によっては「ついうっかりコミットボタンを押してしまっただけなので、コンフリクトの解決だなんて大仰なことはしたくない」ということもあるかも知れません。一度コミットボタンを押してしまってから手元の変更を完全になかったことにするには、以下のように選択して「前回のコミットを元に戻す」を押してください。

![](https://md.trap.jp/uploads/upload_97c357133c28054d4944a8997d90ff46.png)

その後、全てのファイルの変更を破棄して「変更を同期」ボタンを押せば、新たにコミットをすることなく手元の環境をリモートブランチと同じ状態にすることができます。
:::

## まず人に助けを求めよう

コンフリクト（とくにマージ競合）の解決は、方法を誤るとシステムが正常に稼働しなくなるおそれがあるだけに、なかなか集中力が求められる作業です。競合箇所それぞれについて

- なぜコンフリクトしたか
- 競合の片方を優先するとシステム全体にどんな影響が生じるか

をよく確認しながら解決していくことになります。大量にコンフリクトが生じていたり、編集した覚えのないファイルでコンフリクトが生じていたりすると厄介です。

共同開発でしっかり各々の役割分けがなされている場合、それぞれで変更を加えるファイルが異なるのでコンフリクトに出会うことは稀です。もし出会ってしまったら、自分で解決しようとせずチームメイトに助けを求めるのがより早くて安全な解決方法かも知れません。